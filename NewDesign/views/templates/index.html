<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node Engine POC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .header {
            background-color: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
        }
        .main-content {
            padding: 20px;
        }
        .category-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .category-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .subfolder-header {
            background: linear-gradient(135deg, #a8c0ff 0%, #b8a9c9 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .subfolder-container {
            margin-left: 20px;
            border-left: 2px solid #e0e0e0;
        }
        .node-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .node-item:last-child {
            border-bottom: none;
        }
        .node-item:hover {
            background-color: #f8f9fa;
        }
        .node-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .node-icon.blocking { background: #e3f2fd; color: #1976d2; }
        .node-icon.nonblocking { background: #e8f5e9; color: #388e3c; }
        .node-icon.producer { background: #fff3e0; color: #f57c00; }
        .node-icon.logical { background: #fce4ec; color: #c2185b; }
        .node-icon.queue { background: #f3e5f5; color: #7b1fa2; }
        .node-info { flex: 1; }
        .node-name {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .node-name .info-icon {
            color: #2196f3;
            font-size: 0.9rem;
            cursor: help;
        }
        .node-identifier {
            font-size: 0.85rem;
            color: #666;
            font-family: monospace;
        }
        .type-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: #e0e0e0;
            color: #555;
        }
        .btn-add-node {
            background: #2196f3;
            border: none;
            padding: 10px 20px;
            font-weight: 500;
        }
        .modal-body { max-height: 60vh; overflow-y: auto; }
        .modal-category { margin-bottom: 15px; }
        .modal-category-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .modal-subfolder-header {
            background: #f0f4f8;
            padding: 8px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 5px;
            margin-left: 15px;
        }
        .modal-category-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .modal-category-title i { color: #f0ad4e; }
        .modal-node-list { padding-left: 10px; }
        .modal-subfolder-content { margin-left: 15px; }
        .modal-node-item {
            padding: 10px 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .modal-node-item:hover {
            border-color: #2196f3;
            background: #f8f9fa;
        }
        .modal-node-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-node-info { flex: 1; }
        .modal-node-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .modal-node-identifier {
            font-size: 0.8rem;
            color: #888;
            font-family: monospace;
        }
        .stats-bar {
            background: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 30px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        .stat-item strong { color: #333; }
        
        /* Node item clickable style */
        .node-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .node-item:hover {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        /* JSON Modal styles */
        .json-modal .modal-dialog {
            max-width: 800px;
        }
        .json-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .json-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }
        .json-container pre {
            color: #d4d4d4;
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .node-details-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .node-details-header h4 {
            margin: 0 0 10px 0;
        }
        .node-details-header .badge {
            font-size: 0.85rem;
        }
        .node-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .node-meta-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }
        .node-meta-item label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 2px;
            display: block;
        }
        .node-meta-item span {
            font-weight: 500;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        .no-form-message {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        .no-form-message i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    {# Macro to count nodes recursively in a folder structure #}
    {% macro count_nodes(folder_data) %}
        {%- set count = folder_data.nodes|length -%}
        {%- for subfolder_data in folder_data.subfolders.values() -%}
            {%- set count = count + count_nodes(subfolder_data)|int -%}
        {%- endfor -%}
        {{ count }}
    {%- endmacro %}

    {# Recursive macro to render folder content (nodes and subfolders) #}
    {% macro render_folder_content(folder_data, prefix, depth=0) %}
        {# Render nodes directly in this folder #}
        {% for node in folder_data.nodes %}
        <div class="node-item" style="padding-left: {{ 20 + depth * 20 }}px;" onclick="showNodeDetails('{{ node.identifier }}')">
            <div class="node-icon {{ node.type|lower|replace('node', '') }}">
                <i class="bi bi-box"></i>
            </div>
            <div class="node-info">
                <div class="node-name">
                    {{ node.name }}
                    <i class="bi bi-info-circle-fill info-icon" title="Click to view form JSON"></i>
                </div>
                <div class="node-identifier">identifier: {{ node.identifier }}</div>
            </div>
            <span class="type-badge">{{ node.type }}</span>
            <i class="bi bi-chevron-right text-muted"></i>
        </div>
        {% endfor %}

        {# Render subfolders recursively #}
        {% for subfolder_name, subfolder_data in folder_data.subfolders.items() %}
        <div class="subfolder-container">
            <div class="subfolder-header" data-bs-toggle="collapse" data-bs-target="#{{ prefix }}-sub-{{ loop.index }}">
                <div class="category-title">
                    <i class="bi bi-folder-fill"></i>
                    <span>{{ subfolder_name }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="category-badge">{{ count_nodes(subfolder_data)|trim }} nodes</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            <div class="collapse show" id="{{ prefix }}-sub-{{ loop.index }}">
                {{ render_folder_content(subfolder_data, prefix ~ '-sub-' ~ loop.index, depth + 1) }}
            </div>
        </div>
        {% endfor %}
    {% endmacro %}

    {# Recursive macro for modal folder content #}
    {% macro render_modal_folder(folder_data, prefix, depth=0) %}
        {# Render nodes directly in this folder #}
        <div class="modal-node-list" style="margin-left: {{ depth * 15 }}px;">
            {% for node in folder_data.nodes %}
            <div class="modal-node-item" onclick="selectNode('{{ node.identifier }}', '{{ node.name }}')">
                <div class="modal-node-icon {{ node.type|lower|replace('node', '') }}">
                    <i class="bi bi-box"></i>
                </div>
                <div class="modal-node-info">
                    <div class="modal-node-name">
                        {{ node.name }}
                        <i class="bi bi-info-circle-fill text-primary" style="font-size: 0.8rem;"></i>
                    </div>
                    <div class="modal-node-identifier">identifier: {{ node.identifier }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        {# Render subfolders recursively #}
        {% for subfolder_name, subfolder_data in folder_data.subfolders.items() %}
        <div class="modal-subfolder-content">
            <div class="modal-subfolder-header" data-bs-toggle="collapse" data-bs-target="#{{ prefix }}-msub-{{ loop.index }}">
                <div class="modal-category-title">
                    <i class="bi bi-folder-fill"></i>
                    <span>{{ subfolder_name }}</span>
                    <small class="text-muted">({{ count_nodes(subfolder_data)|trim }} nodes)</small>
                </div>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse show" id="{{ prefix }}-msub-{{ loop.index }}">
                {{ render_modal_folder(subfolder_data, prefix ~ '-msub-' ~ loop.index, depth + 1) }}
            </div>
        </div>
        {% endfor %}
    {% endmacro %}

    <div class="header">
        <h1>Node Engine POC</h1>
        <button class="btn btn-primary btn-add-node" data-bs-toggle="modal" data-bs-target="#nodeModal">
            <i class="bi bi-plus"></i> Add Node
        </button>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <i class="bi bi-diagram-3"></i>
            <span>Total Nodes: <strong>{{ total_count }}</strong></span>
        </div>
        <div class="stat-item">
            <i class="bi bi-folder"></i>
            <span>Categories: <strong>{{ nodes|length }}</strong></span>
        </div>
    </div>

    <div class="main-content">
        <div class="row">
            <div class="col-12">
                {% for category, folder_data in nodes.items() %}
                <div class="category-card">
                    <div class="category-header" data-bs-toggle="collapse" data-bs-target="#cat-{{ loop.index }}">
                        <div class="category-title">
                            <i class="bi bi-folder-fill"></i>
                            <span>{{ category }}</span>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="category-badge">{{ count_nodes(folder_data)|trim }} nodes</span>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapse show" id="cat-{{ loop.index }}">
                        {{ render_folder_content(folder_data, 'cat-' ~ loop.index) }}
                    </div>
                </div>
                {% endfor %}
                {% if not nodes %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No nodes found.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Node Modal -->
    <div class="modal fade" id="nodeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Node Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% for category, folder_data in nodes.items() %}
                    <div class="modal-category">
                        <div class="modal-category-header" data-bs-toggle="collapse" data-bs-target="#mcat-{{ loop.index }}">
                            <div class="modal-category-title">
                                <i class="bi bi-folder-fill"></i>
                                <span>{{ category }}</span>
                                <small class="text-muted">({{ count_nodes(folder_data)|trim }} nodes)</small>
                            </div>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div class="collapse show" id="mcat-{{ loop.index }}">
                            {{ render_modal_folder(folder_data, 'mcat-' ~ loop.index) }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Node Details/JSON Modal -->
    <div class="modal fade json-modal" id="nodeDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-code-slash me-2"></i>
                        Node Form Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="nodeDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var tooltips = [].slice.call(document.querySelectorAll('[title]'));
        tooltips.forEach(function(el) { new bootstrap.Tooltip(el); });
        
        function selectNode(id, name) {
            // Show node details when selecting from Add Node modal
            showNodeDetails(id);
            bootstrap.Modal.getInstance(document.getElementById('nodeModal')).hide();
        }
        
        function showNodeDetails(identifier) {
            var modal = new bootstrap.Modal(document.getElementById('nodeDetailsModal'));
            var contentEl = document.getElementById('nodeDetailsContent');
            
            // Show loading state
            contentEl.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            modal.show();
            
            // Fetch node form data
            fetch('/api/node/' + encodeURIComponent(identifier) + '/form')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    renderNodeDetails(data, contentEl);
                })
                .catch(function(error) {
                    contentEl.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading node details: ${error.message}
                        </div>
                    `;
                });
        }
        
        function renderNodeDetails(data, containerEl) {
            var node = data.node || {};
            var form = data.form;
            
            var html = `
                <div class="node-details-header">
                    <h4>${node.name || 'Unknown Node'}</h4>
                    <span class="badge bg-light text-dark">${node.type || 'Unknown Type'}</span>
                    ${node.has_form ? '<span class="badge bg-success ms-2">Has Form</span>' : '<span class="badge bg-secondary ms-2">No Form</span>'}
                    <div class="node-meta">
                        <div class="node-meta-item">
                            <label>Identifier</label>
                            <span>${node.identifier || '-'}</span>
                        </div>
                        <div class="node-meta-item">
                            <label>Label</label>
                            <span>${node.label || '-'}</span>
                        </div>
                        <div class="node-meta-item">
                            <label>Description</label>
                            <span>${node.description || '-'}</span>
                        </div>
                        <div class="node-meta-item">
                            <label>Form Class</label>
                            <span>${node.form_class || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            if (form) {
                html += `
                    <h6 class="mb-3">
                        <i class="bi bi-braces me-2"></i>
                        Form JSON Schema
                    </h6>
                    <div class="json-container">
                        <pre>${syntaxHighlight(JSON.stringify(form, null, 2))}</pre>
                    </div>
                `;
            } else {
                html += `
                    <div class="no-form-message">
                        <i class="bi bi-file-earmark-x d-block"></i>
                        <h5>No Form Configuration</h5>
                        <p class="text-muted mb-0">${data.message || 'This node does not have a form definition.'}</p>
                    </div>
                `;
            }
            
            containerEl.innerHTML = html;
        }
        
        // JSON syntax highlighting
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'color: #b5cea8;'; // number
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'color: #9cdcfe;'; // key
                        match = match.replace(/"/g, '');
                        match = '"' + match;
                    } else {
                        cls = 'color: #ce9178;'; // string
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'color: #569cd6;'; // boolean
                } else if (/null/.test(match)) {
                    cls = 'color: #569cd6;'; // null
                }
                return '<span style="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>
</html>
