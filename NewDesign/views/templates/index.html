<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node Engine POC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .header {
            background-color: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
        }
        .main-content {
            padding: 20px;
        }
        .category-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .category-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .subfolder-header {
            background: linear-gradient(135deg, #a8c0ff 0%, #b8a9c9 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .subfolder-container {
            margin-left: 20px;
            border-left: 2px solid #e0e0e0;
        }
        .node-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .node-item:last-child {
            border-bottom: none;
        }
        .node-item:hover {
            background-color: #f8f9fa;
        }
        .node-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .node-icon.blocking { background: #e3f2fd; color: #1976d2; }
        .node-icon.nonblocking { background: #e8f5e9; color: #388e3c; }
        .node-icon.producer { background: #fff3e0; color: #f57c00; }
        .node-icon.logical { background: #fce4ec; color: #c2185b; }
        .node-icon.queue { background: #f3e5f5; color: #7b1fa2; }
        .node-info { flex: 1; }
        .node-name {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .node-name .info-icon {
            color: #2196f3;
            font-size: 0.9rem;
            cursor: help;
        }
        .node-identifier {
            font-size: 0.85rem;
            color: #666;
            font-family: monospace;
        }
        .type-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: #e0e0e0;
            color: #555;
        }
        .btn-add-node {
            background: #2196f3;
            border: none;
            padding: 10px 20px;
            font-weight: 500;
        }
        .modal-body { max-height: 60vh; overflow-y: auto; }
        .modal-category { margin-bottom: 15px; }
        .modal-category-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .modal-subfolder-header {
            background: #f0f4f8;
            padding: 8px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 5px;
            margin-left: 15px;
        }
        .modal-category-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .modal-category-title i { color: #f0ad4e; }
        .modal-node-list { padding-left: 10px; }
        .modal-subfolder-content { margin-left: 15px; }
        .modal-node-item {
            padding: 10px 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .modal-node-item:hover {
            border-color: #2196f3;
            background: #f8f9fa;
        }
        .modal-node-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-node-info { flex: 1; }
        .modal-node-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .modal-node-identifier {
            font-size: 0.8rem;
            color: #888;
            font-family: monospace;
        }
        .stats-bar {
            background: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 30px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        .stat-item strong { color: #333; }
        
        /* Node item clickable style */
        .node-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .node-item:hover {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        /* JSON Modal styles */
        .json-modal .modal-dialog {
            max-width: 800px;
        }
        .json-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .json-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }
        .json-container pre {
            color: #d4d4d4;
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .node-details-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .node-details-header h4 {
            margin: 0 0 10px 0;
        }
        .node-details-header .badge {
            font-size: 0.85rem;
        }
        .node-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .node-meta-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }
        .node-meta-item label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 2px;
            display: block;
        }
        .node-meta-item span {
            font-weight: 500;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        .no-form-message {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        .no-form-message i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        /* Rendered Form Styles */
        .form-tabs {
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .form-tabs .nav-link {
            border: none;
            color: #666;
            padding: 12px 20px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .form-tabs .nav-link:hover {
            color: #333;
            border-color: #ccc;
        }
        .form-tabs .nav-link.active {
            color: #667eea;
            border-color: #667eea;
            background: none;
        }
        .rendered-form {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
        }
        .form-field {
            margin-bottom: 20px;
        }
        .form-field label {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            display: block;
        }
        .form-field .form-help {
            font-size: 0.85rem;
            color: #888;
            margin-top: 4px;
        }
        .form-field .field-required {
            color: #dc3545;
            margin-left: 2px;
        }
        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-field input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        .field-meta {
            display: flex;
            gap: 10px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .field-meta-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: #f0f0f0;
            color: #666;
        }
        .field-meta-badge.required {
            background: #fff3cd;
            color: #856404;
        }
        .field-meta-badge.type {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        /* Play button styles */
        .btn-play-node {
            background: transparent;
            border: none;
            color: #2196f3;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-play-node:hover {
            background: #e3f2fd;
            color: #1565c0;
            transform: scale(1.1);
        }
        
        /* Execution Popup Styles */
        .execution-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1050;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .execution-overlay.show {
            display: flex;
        }
        .execution-popup {
            background: #2d2d2d;
            border-radius: 12px;
            width: 100%;
            max-width: 1400px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .execution-content {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        /* Input/Output Panels */
        .execution-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            min-width: 0;
        }
        .execution-panel.io-panel {
            background: #1e1e1e;
        }
        .panel-header {
            background: #3d3d3d;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        .panel-content {
            flex: 1;
            overflow: auto;
            border-radius: 8px;
        }
        .json-editor {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background: #1e1e1e;
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 15px;
            resize: none;
        }
        .json-editor:focus {
            outline: none;
            border-color: #667eea;
        }
        .json-output {
            background: #1e1e1e;
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            overflow: auto;
        }
        .json-output pre {
            margin: 0;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Form Panel */
        .execution-panel.form-panel {
            background: #f5f5f5;
            max-width: 400px;
            min-width: 350px;
        }
        .form-panel-header {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .form-panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #333;
        }
        .form-panel-title i {
            color: #667eea;
        }
        .btn-close-popup {
            background: #ff5252;
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-close-popup:hover {
            background: #ff1744;
        }
        .form-panel-content {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        .form-panel-content .form-field {
            margin-bottom: 15px;
        }
        .form-panel-content .form-field label {
            font-weight: 500;
            color: #333;
            margin-bottom: 6px;
            display: block;
            font-size: 0.9rem;
        }
        .form-panel-content .form-field input,
        .form-panel-content .form-field textarea,
        .form-panel-content .form-field select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .form-panel-content .form-field textarea {
            min-height: 100px;
            resize: vertical;
        }
        .btn-execute {
            background: #e53935;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: background 0.2s;
        }
        .btn-execute:hover {
            background: #c62828;
        }
        .btn-execute:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }
        .btn-execute .spinner-border {
            width: 1rem;
            height: 1rem;
            margin-right: 8px;
        }
        
        /* Output states */
        .output-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 40px;
        }
        .output-placeholder i {
            font-size: 3rem;
            color: #444;
            margin-bottom: 15px;
        }
        .output-error {
            color: #ff5252;
        }
        .output-error pre {
            color: #ff5252 !important;
        }
    </style>
</head>
<body>
    {# Macro to count nodes recursively in a folder structure #}
    {% macro count_nodes(folder_data) %}
        {%- set ns = namespace(count=folder_data.nodes|length) -%}
        {%- for subfolder_data in folder_data.subfolders.values() -%}
            {%- set ns.count = ns.count + count_nodes(subfolder_data)|int -%}
        {%- endfor -%}
        {{ ns.count }}
    {%- endmacro %}

    {# Recursive macro to render folder content (nodes and subfolders) #}
    {% macro render_folder_content(folder_data, prefix, depth=0) %}
        {# Render nodes directly in this folder #}
        {% for node in folder_data.nodes %}
        <div class="node-item" style="padding-left: {{ 20 + depth * 20 }}px;" onclick="showNodeDetails('{{ node.identifier }}')">
            <div class="node-icon {{ node.type|lower|replace('node', '') }}">
                <i class="bi bi-box"></i>
            </div>
            <div class="node-info">
                <div class="node-name">
                    {{ node.name }}
                    <i class="bi bi-info-circle-fill info-icon" title="Click to view form JSON"></i>
                </div>
                <div class="node-identifier">identifier: {{ node.identifier }}</div>
            </div>
            <span class="type-badge">{{ node.type }}</span>
            {% if node.has_form %}
            <button class="btn-play-node" onclick="event.stopPropagation(); openExecutionPopup('{{ node.identifier }}', '{{ node.name }}')" title="Execute Node">
                <i class="bi bi-play-fill"></i>
            </button>
            {% endif %}
        </div>
        {% endfor %}

        {# Render subfolders recursively #}
        {% for subfolder_name, subfolder_data in folder_data.subfolders.items() %}
        <div class="subfolder-container">
            <div class="subfolder-header" data-bs-toggle="collapse" data-bs-target="#{{ prefix }}-sub-{{ loop.index }}">
                <div class="category-title">
                    <i class="bi bi-folder-fill"></i>
                    <span>{{ subfolder_name }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="category-badge">{{ count_nodes(subfolder_data)|trim }} nodes</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            <div class="collapse show" id="{{ prefix }}-sub-{{ loop.index }}">
                {{ render_folder_content(subfolder_data, prefix ~ '-sub-' ~ loop.index, depth + 1) }}
            </div>
        </div>
        {% endfor %}
    {% endmacro %}

    {# Recursive macro for modal folder content #}
    {% macro render_modal_folder(folder_data, prefix, depth=0) %}
        {# Render nodes directly in this folder #}
        <div class="modal-node-list" style="margin-left: {{ depth * 15 }}px;">
            {% for node in folder_data.nodes %}
            <div class="modal-node-item" onclick="selectNode('{{ node.identifier }}', '{{ node.name }}')">
                <div class="modal-node-icon {{ node.type|lower|replace('node', '') }}">
                    <i class="bi bi-box"></i>
                </div>
                <div class="modal-node-info">
                    <div class="modal-node-name">
                        {{ node.name }}
                        <i class="bi bi-info-circle-fill text-primary" style="font-size: 0.8rem;"></i>
                    </div>
                    <div class="modal-node-identifier">identifier: {{ node.identifier }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        {# Render subfolders recursively #}
        {% for subfolder_name, subfolder_data in folder_data.subfolders.items() %}
        <div class="modal-subfolder-content">
            <div class="modal-subfolder-header" data-bs-toggle="collapse" data-bs-target="#{{ prefix }}-msub-{{ loop.index }}">
                <div class="modal-category-title">
                    <i class="bi bi-folder-fill"></i>
                    <span>{{ subfolder_name }}</span>
                    <small class="text-muted">({{ count_nodes(subfolder_data)|trim }} nodes)</small>
                </div>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse show" id="{{ prefix }}-msub-{{ loop.index }}">
                {{ render_modal_folder(subfolder_data, prefix ~ '-msub-' ~ loop.index, depth + 1) }}
            </div>
        </div>
        {% endfor %}
    {% endmacro %}

    <div class="header">
        <h1>Node Engine POC</h1>
        <button class="btn btn-primary btn-add-node" data-bs-toggle="modal" data-bs-target="#nodeModal">
            <i class="bi bi-plus"></i> Add Node
        </button>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <i class="bi bi-diagram-3"></i>
            <span>Total Nodes: <strong>{{ total_count }}</strong></span>
        </div>
        <div class="stat-item">
            <i class="bi bi-folder"></i>
            <span>Categories: <strong>{{ nodes|length }}</strong></span>
        </div>
    </div>

    <div class="main-content">
        <div class="row">
            <div class="col-12">
                {% for category, folder_data in nodes.items() %}
                <div class="category-card">
                    <div class="category-header" data-bs-toggle="collapse" data-bs-target="#cat-{{ loop.index }}">
                        <div class="category-title">
                            <i class="bi bi-folder-fill"></i>
                            <span>{{ category }}</span>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="category-badge">{{ count_nodes(folder_data)|trim }} nodes</span>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapse show" id="cat-{{ loop.index }}">
                        {{ render_folder_content(folder_data, 'cat-' ~ loop.index) }}
                    </div>
                </div>
                {% endfor %}
                {% if not nodes %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No nodes found.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Node Modal -->
    <div class="modal fade" id="nodeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Node Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% for category, folder_data in nodes.items() %}
                    <div class="modal-category">
                        <div class="modal-category-header" data-bs-toggle="collapse" data-bs-target="#mcat-{{ loop.index }}">
                            <div class="modal-category-title">
                                <i class="bi bi-folder-fill"></i>
                                <span>{{ category }}</span>
                                <small class="text-muted">({{ count_nodes(folder_data)|trim }} nodes)</small>
                            </div>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div class="collapse show" id="mcat-{{ loop.index }}">
                            {{ render_modal_folder(folder_data, 'mcat-' ~ loop.index) }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Node Details/JSON Modal -->
    <div class="modal fade json-modal" id="nodeDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-code-slash me-2"></i>
                        Node Form Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="nodeDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Popup -->
    <div class="execution-overlay" id="executionOverlay">
        <div class="execution-popup">
            <div class="execution-content">
                <!-- Input Panel -->
                <div class="execution-panel io-panel">
                    <div class="panel-header">Input</div>
                    <div class="panel-content">
                        <textarea class="json-editor" id="executionInput" placeholder="Enter input JSON data..."></textarea>
                    </div>
                </div>
                
                <!-- Form Panel -->
                <div class="execution-panel form-panel">
                    <div class="form-panel-header">
                        <div class="form-panel-title">
                            <i class="bi bi-diagram-3"></i>
                            <span id="executionNodeName">Node Name</span>
                        </div>
                        <button class="btn-close-popup" onclick="closeExecutionPopup()" title="Close">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="form-panel-content" id="executionFormContent">
                        <!-- Form fields will be rendered here -->
                    </div>
                    <button class="btn-execute" id="btnExecute" onclick="executeNode()">
                        Execute
                    </button>
                </div>
                
                <!-- Output Panel -->
                <div class="execution-panel io-panel">
                    <div class="panel-header">Output</div>
                    <div class="panel-content">
                        <div class="json-output" id="executionOutput">
                            <div class="output-placeholder">
                                <i class="bi bi-play-circle"></i>
                                <p>Click Execute to run the node and see the output</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var tooltips = [].slice.call(document.querySelectorAll('[title]'));
        tooltips.forEach(function(el) { new bootstrap.Tooltip(el); });
        
        // Execution popup state
        var currentNodeIdentifier = null;
        var currentNodeFormFields = [];
        
        // Default input JSON template
        var defaultInputJson = {
            "url": "https://www.freelancer.in/projects/git/web-development-intern-with-react.html",
            "title": "Web Development Intern with React Skills",
            "budget": "Budget \u20B91,500 \u2013 12,500 INR",
            "parsed_budget": {
                "min": "1500",
                "max": "12500",
                "currency_symbol": "\u20B9",
                "currency": "INR",
                "per_hour": false
            },
            "description": "I'm seeking an intern for a web development position who is eager to learn and contribute to our projects.",
            "skills": ["Documentation", "Frontend Development", "Git", "HTML", "HTML5"],
            "ClientRating": 5,
            "ClientReviews": 27,
            "timestamp": new Date().toISOString()
        };
        
        function openExecutionPopup(identifier, nodeName) {
            currentNodeIdentifier = identifier;
            
            // Update popup header
            document.getElementById('executionNodeName').textContent = nodeName;
            
            // Set default input JSON
            document.getElementById('executionInput').value = JSON.stringify(defaultInputJson, null, 2);
            
            // Reset output
            document.getElementById('executionOutput').innerHTML = `
                <div class="output-placeholder">
                    <i class="bi bi-play-circle"></i>
                    <p>Click Execute to run the node and see the output</p>
                </div>
            `;
            
            // Show popup
            document.getElementById('executionOverlay').classList.add('show');
            
            // Load form fields
            loadExecutionForm(identifier);
        }
        
        function closeExecutionPopup() {
            document.getElementById('executionOverlay').classList.remove('show');
            currentNodeIdentifier = null;
            currentNodeFormFields = [];
        }
        
        function loadExecutionForm(identifier) {
            var formContent = document.getElementById('executionFormContent');
            formContent.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            fetch('/api/node/' + encodeURIComponent(identifier) + '/form')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.form && data.form.fields && data.form.fields.length > 0) {
                        currentNodeFormFields = data.form.fields;
                        formContent.innerHTML = renderExecutionFormFields(data.form.fields);
                    } else {
                        currentNodeFormFields = [];
                        formContent.innerHTML = `
                            <div class="output-placeholder">
                                <i class="bi bi-file-earmark-x"></i>
                                <p>This node has no form fields</p>
                            </div>
                        `;
                    }
                })
                .catch(function(error) {
                    formContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading form: ${error.message}
                        </div>
                    `;
                });
        }
        
        function renderExecutionFormFields(fields) {
            var html = '';
            
            fields.forEach(function(field, index) {
                var fieldId = 'exec_field_' + index;
                var fieldName = field.name || 'field_' + index;
                var label = field.label || field.name || 'Field';
                var isRequired = field.required === true;
                
                html += '<div class="form-field">';
                html += '<label for="' + fieldId + '">' + escapeHtml(label);
                if (isRequired) {
                    html += '<span class="field-required" style="color: #dc3545; margin-left: 2px;">*</span>';
                }
                html += '</label>';
                
                // Render input based on field type
                if (field.tag === 'select' && field.options) {
                    html += '<select class="form-select" id="' + fieldId + '" data-field-name="' + fieldName + '">';
                    field.options.forEach(function(opt) {
                        var selected = opt.selected ? ' selected' : '';
                        html += '<option value="' + escapeHtml(opt.value) + '"' + selected + '>' + escapeHtml(opt.text) + '</option>';
                    });
                    html += '</select>';
                } else if (field.tag === 'textarea') {
                    html += '<textarea id="' + fieldId + '" data-field-name="' + fieldName + '" rows="3" placeholder="' + escapeHtml(field.placeholder || '') + '"></textarea>';
                } else if (field.type === 'checkbox') {
                    html += '<div><input type="checkbox" id="' + fieldId + '" data-field-name="' + fieldName + '"> <span>' + escapeHtml(label) + '</span></div>';
                } else {
                    var inputType = field.type || 'text';
                    if (inputType === 'number') {
                        var min = field.min !== undefined ? ' min="' + field.min + '"' : '';
                        var max = field.max !== undefined ? ' max="' + field.max + '"' : '';
                        html += '<input type="number" id="' + fieldId + '" data-field-name="' + fieldName + '"' + min + max + ' placeholder="' + escapeHtml(field.placeholder || '') + '">';
                    } else {
                        html += '<input type="' + inputType + '" id="' + fieldId + '" data-field-name="' + fieldName + '" placeholder="' + escapeHtml(field.placeholder || '') + '">';
                    }
                }
                
                html += '</div>';
            });
            
            return html;
        }
        
        function collectFormData() {
            var formData = {};
            
            currentNodeFormFields.forEach(function(field, index) {
                var fieldId = 'exec_field_' + index;
                var fieldName = field.name || 'field_' + index;
                var element = document.getElementById(fieldId);
                
                if (element) {
                    if (element.type === 'checkbox') {
                        formData[fieldName] = element.checked;
                    } else {
                        formData[fieldName] = element.value;
                    }
                }
            });
            
            return formData;
        }
        
        function executeNode() {
            if (!currentNodeIdentifier) {
                alert('No node selected');
                return;
            }
            
            var btn = document.getElementById('btnExecute');
            var outputEl = document.getElementById('executionOutput');
            
            // Get input JSON
            var inputText = document.getElementById('executionInput').value;
            var inputData;
            
            try {
                inputData = JSON.parse(inputText);
            } catch (e) {
                outputEl.innerHTML = `
                    <div class="output-error">
                        <pre>Error: Invalid input JSON\n${e.message}</pre>
                    </div>
                `;
                return;
            }
            
            // Get form data
            var formData = collectFormData();
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Executing...';
            outputEl.innerHTML = `
                <div class="output-placeholder">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Executing...</span>
                    </div>
                    <p>Executing node...</p>
                </div>
            `;
            
            // Call execute API
            fetch('/api/node/' + encodeURIComponent(currentNodeIdentifier) + '/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    input_data: inputData,
                    form_data: formData
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                btn.disabled = false;
                btn.innerHTML = 'Execute';
                
                if (data.error) {
                    outputEl.innerHTML = `
                        <div class="output-error">
                            <pre>${syntaxHighlight(JSON.stringify(data, null, 2))}</pre>
                        </div>
                    `;
                } else {
                    outputEl.innerHTML = `<pre>${syntaxHighlight(JSON.stringify(data.output || data, null, 2))}</pre>`;
                }
            })
            .catch(function(error) {
                btn.disabled = false;
                btn.innerHTML = 'Execute';
                outputEl.innerHTML = `
                    <div class="output-error">
                        <pre>Error: ${error.message}</pre>
                    </div>
                `;
            });
        }
        
        // Close popup on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('executionOverlay').classList.contains('show')) {
                closeExecutionPopup();
            }
        });
        
        // Close popup on clicking overlay background
        document.getElementById('executionOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeExecutionPopup();
            }
        });
        
        function selectNode(id, name) {
            // Show node details when selecting from Add Node modal
            showNodeDetails(id);
            bootstrap.Modal.getInstance(document.getElementById('nodeModal')).hide();
        }
        
        function showNodeDetails(identifier) {
            var modal = new bootstrap.Modal(document.getElementById('nodeDetailsModal'));
            var contentEl = document.getElementById('nodeDetailsContent');
            
            // Show loading state
            contentEl.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            modal.show();
            
            // Fetch node form data
            fetch('/api/node/' + encodeURIComponent(identifier) + '/form')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    renderNodeDetails(data, contentEl);
                })
                .catch(function(error) {
                    contentEl.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading node details: ${error.message}
                        </div>
                    `;
                });
        }
        
        function renderNodeDetails(data, containerEl) {
            var node = data.node || {};
            var form = data.form;
            
            var html = `
                <div class="node-details-header">
                    <h4>${node.name || 'Unknown Node'}</h4>
                    <span class="badge bg-light text-dark">${node.type || 'Unknown Type'}</span>
                    ${form ? '<span class="badge bg-success ms-2">Has Form</span>' : '<span class="badge bg-secondary ms-2">No Form</span>'}
                    <div class="node-meta">
                        <div class="node-meta-item">
                            <label>Identifier</label>
                            <span>${node.identifier || '-'}</span>
                        </div>
                        <div class="node-meta-item">
                            <label>Label</label>
                            <span>${node.label || '-'}</span>
                        </div>
                        <div class="node-meta-item">
                            <label>Description</label>
                            <span>${node.description || '-'}</span>
                        </div>
                        <div class="node-meta-item">
                            <label>Form Class</label>
                            <span>${node.form_class || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            if (form && form.fields && form.fields.length > 0) {
                html += `
                    <ul class="nav nav-tabs form-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="rendered-tab" data-bs-toggle="tab" data-bs-target="#rendered-pane" type="button" role="tab">
                                <i class="bi bi-ui-checks me-2"></i>Rendered Form
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-pane" type="button" role="tab">
                                <i class="bi bi-braces me-2"></i>JSON Schema
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="rendered-pane" role="tabpanel">
                            <div class="rendered-form">
                                ${renderFormFields(form.fields)}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="json-pane" role="tabpanel">
                            <div class="json-container">
                                <pre>${syntaxHighlight(JSON.stringify(form, null, 2))}</pre>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="no-form-message">
                        <i class="bi bi-file-earmark-x d-block"></i>
                        <h5>No Form Configuration</h5>
                        <p class="text-muted mb-0">${data.message || 'This node does not have a form definition.'}</p>
                    </div>
                `;
            }
            
            containerEl.innerHTML = html;
        }
        
        function renderFormFields(fields) {
            var html = '';
            
            fields.forEach(function(field) {
                var fieldHtml = '<div class="form-field">';
                
                // Label
                var label = field.label || field.name || 'Field';
                var isRequired = field.required === true;
                fieldHtml += '<label>' + escapeHtml(label);
                if (isRequired) {
                    fieldHtml += '<span class="field-required">*</span>';
                }
                fieldHtml += '</label>';
                
                // Render input based on tag type
                if (field.tag === 'select' && field.options) {
                    fieldHtml += '<select class="form-select">';
                    field.options.forEach(function(opt) {
                        var selected = opt.selected ? ' selected' : '';
                        fieldHtml += '<option value="' + escapeHtml(opt.value) + '"' + selected + '>' + escapeHtml(opt.text) + '</option>';
                    });
                    fieldHtml += '</select>';
                } else if (field.tag === 'textarea') {
                    fieldHtml += '<textarea rows="3" placeholder="' + escapeHtml(field.placeholder || '') + '"></textarea>';
                } else if (field.type === 'checkbox') {
                    fieldHtml += '<div><input type="checkbox"> <span>' + escapeHtml(label) + '</span></div>';
                } else {
                    var inputType = field.type || 'text';
                    if (inputType === 'number') {
                        var min = field.min !== undefined ? ' min="' + field.min + '"' : '';
                        var max = field.max !== undefined ? ' max="' + field.max + '"' : '';
                        fieldHtml += '<input type="number"' + min + max + ' placeholder="' + escapeHtml(field.placeholder || '') + '">';
                    } else {
                        fieldHtml += '<input type="' + inputType + '" placeholder="' + escapeHtml(field.placeholder || '') + '">';
                    }
                }
                
                // Field metadata badges
                fieldHtml += '<div class="field-meta">';
                if (isRequired) {
                    fieldHtml += '<span class="field-meta-badge required">Required</span>';
                }
                if (field.type) {
                    fieldHtml += '<span class="field-meta-badge type">' + escapeHtml(field.type) + '</span>';
                }
                if (field.tag) {
                    fieldHtml += '<span class="field-meta-badge">' + escapeHtml(field.tag) + '</span>';
                }
                fieldHtml += '</div>';
                
                // Help text
                if (field.help_text) {
                    fieldHtml += '<div class="form-help">' + escapeHtml(field.help_text) + '</div>';
                }
                
                fieldHtml += '</div>';
                html += fieldHtml;
            });
            
            return html;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // JSON syntax highlighting
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'color: #b5cea8;'; // number
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'color: #9cdcfe;'; // key
                        match = match.replace(/"/g, '');
                        match = '"' + match;
                    } else {
                        cls = 'color: #ce9178;'; // string
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'color: #569cd6;'; // boolean
                } else if (/null/.test(match)) {
                    cls = 'color: #569cd6;'; // null
                }
                return '<span style="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>
</html>
